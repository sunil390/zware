---
- hosts: vs01
  collections:
    - ibm.ibm_zos_core
  gather_facts: false

  vars:
  environment: "{{ environment_vars }}"

  tasks:
    - name: "Fail if jobname is not provided"
      ansible.builtin.fail:
        msg: "The 'jobname' variable was not provided. Please supply it as an extra variable in your AWX job template."
      when: jobname is not defined or jobname == ""

    - name: "Get all spool files for job {{ jobname }}"
      ibm.ibm_zos_core.zos_job_output:
        job_name: "{{ jobname | upper }}"
      register: job_output_result

    - name: "Display the ENTIRE Mainframe Job Output"
      ansible.builtin.debug:
        msg: |
          --- BEGIN MAINFRAME JOB LOG ---
          {% if job_output_result.jobs is defined and job_output_result.jobs | length > 0 %}
          {# THIS IS THE FIX: Loop through each DDNAME (spool file) in the list #}
          {% for dd in job_output_result.jobs[0].ddnames %}

          --- DDNAME: {{ dd.ddname | default('N/A') }} ---
          {# Loop through each line of content within that DDNAME #}
          {% for line in dd.content %}
          {{ line }}
          {% endfor %}

          {% endfor %}
          {% else %}
          JOB NOT FOUND: No job output found for '{{ jobname | upper }}'. The job may not exist, may have purged, or you may lack permissions to view it.
          {% endif %}
          --- END MAINFRAME JOB LOG ---
      when: jobname is defined and jobname != ""

    - name: Set the log content as a job artifact for AWX
      set_stats:
        data:
          job_content: "{{ job_output_result }}"
